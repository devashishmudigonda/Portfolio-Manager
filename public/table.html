<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Table View</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .nav { margin: 20px 0; }
        .nav a { margin-right: 20px; padding: 10px; background: #007cba; color: white; text-decoration: none; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .delete-btn { background-color: #ff4444; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .total { font-weight: bold; background-color: #e8f4f8; }
        .gain { color: #28a745; font-weight: bold; }
        .loss { color: #dc3545; font-weight: bold; }
        .risk-low { color: #28a745; }
        .risk-medium { color: #ffc107; }
        .risk-high { color: #dc3545; }
        table { font-size: 12px; }
        th, td { padding: 6px; }
    </style>
</head>
<body>
    <h1>Portfolio Holdings - Table View</h1>
    
    <div class="nav">
        <a href="index.html">Add Holdings</a>
        <a href="charts.html">View Charts</a>
    </div>
    
    <div id="portfolio-table"></div>

    <script>
        const API_URL = '/api/portfolio';

        async function loadPortfolio() {
            try {
                const response = await fetch(API_URL);
                const holdings = await response.json();
                displayPortfolio(holdings);
            } catch (error) {
                console.error('Error loading portfolio:', error);
                document.getElementById('portfolio-table').innerHTML = '<p>Error loading portfolio data.</p>';
            }
        }

        function displayPortfolio(holdings) {
            const tableDiv = document.getElementById('portfolio-table');
            if (holdings.length === 0) {
                tableDiv.innerHTML = '<p>No holdings found. <a href="index.html">Add some holdings</a></p>';
                return;
            }

            const totalVolume = holdings.reduce((sum, holding) => sum + holding.volume, 0);
            const totalValue = holdings.reduce((sum, holding) => sum + (holding.current_price * holding.volume), 0);
            const totalCost = holdings.reduce((sum, holding) => sum + (holding.purchase_price * holding.volume), 0);
            const totalGainLoss = totalValue - totalCost;

            let html = `
                <table>
                    <tr>
                        <th>Ticker</th>
                        <th>Company</th>
                        <th>Type</th>
                        <th>Volume</th>
                        <th>Purchase Price</th>
                        <th>Current Price</th>
                        <th>Total Value</th>
                        <th>Gain/Loss</th>
                        <th>Sector</th>
                        <th>Risk</th>
                        <th>Actions</th>
                    </tr>
            `;
            
            holdings.forEach(holding => {
                const totalHoldingValue = holding.current_price * holding.volume;
                const totalHoldingCost = holding.purchase_price * holding.volume;
                const gainLoss = totalHoldingValue - totalHoldingCost;
                const gainLossClass = gainLoss >= 0 ? 'gain' : 'loss';
                
                html += `
                    <tr>
                        <td><strong>${holding.stock_ticker}</strong></td>
                        <td>${holding.company_name}</td>
                        <td>${holding.asset_type}</td>
                        <td>${holding.volume}</td>
                        <td>₹${holding.purchase_price}</td>
                        <td>₹${holding.current_price}</td>
                        <td>₹${totalHoldingValue.toFixed(2)}</td>
                        <td class="${gainLossClass}">₹${gainLoss.toFixed(2)}</td>
                        <td>${holding.sector || '-'}</td>
                        <td class="risk-${holding.risk_level}">${holding.risk_level}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteHolding(${holding.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    <tr class="total">
                        <td colspan="6"><strong>Portfolio Totals</strong></td>
                        <td><strong>₹${totalValue.toFixed(2)}</strong></td>
                        <td class="${totalGainLoss >= 0 ? 'gain' : 'loss'}"><strong>₹${totalGainLoss.toFixed(2)}</strong></td>
                        <td colspan="3"><strong>${holdings.length} holdings</strong></td>
                    </tr>
                </table>
            `;
            tableDiv.innerHTML = html;
        }

        async function deleteHolding(id) {
            if (!confirm('Are you sure you want to delete this holding?')) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadPortfolio();
                } else {
                    alert('Error deleting holding');
                }
            } catch (error) {
                console.error('Error deleting holding:', error);
                alert('Network error. Please try again.');
            }
        }

        loadPortfolio();
    </script>
</body>
</html>