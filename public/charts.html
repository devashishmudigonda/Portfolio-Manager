<!DOCTYPE html>
<html>
<head>
    <title>Analytics Dashboard - Portfolio Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="bootstrap-custom.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

</head>
<body>
    <div class="d-flex">
        <nav class="sidebar p-4">
            <div class="border-bottom pb-3 mb-4">
                <h2 class="h4 text-dark mb-1">Portfolio Pro</h2>
                <small class="text-muted">Investment Management</small>
            </div>
            <div class="nav flex-column">
                <a href="index.html" class="nav-link text-dark text-decoration-none py-3 px-3 mb-2 rounded">
                    <i class="fas fa-plus-circle me-2"></i> Add Holdings
                </a>
                <a href="sell.html" class="nav-link text-dark text-decoration-none py-3 px-3 mb-2 rounded">
                    <i class="fas fa-minus-circle me-2"></i> Sell Holdings
                </a>
                <a href="table.html" class="nav-link text-dark text-decoration-none py-3 px-3 mb-2 rounded">
                    <i class="fas fa-table me-2"></i> View Portfolio
                </a>
                <a href="charts.html" class="nav-link nav-item active text-decoration-none py-3 px-3 mb-2 rounded">
                    <i class="fas fa-chart-line me-2"></i> Analytics
                </a>
                <a href="transactions.html" class="nav-link text-dark text-decoration-none py-3 px-3 mb-2 rounded">
                    <i class="fas fa-exchange-alt me-2"></i> Transactions
                </a>
            </div>
            <div class="mt-auto pt-4 border-top">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <span class="text-muted small">Currency</span>
                    <label class="theme-switch">
                        <input type="checkbox" id="currency-toggle" onchange="toggleCurrency()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="d-flex align-items-center justify-content-between">
                    <span class="text-muted small">Dark Mode</span>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </nav>
        
        <main class="main-content flex-fill p-4">
            <div class="glass-card rounded-4 p-4 mb-4">
                <h1 class="h2 text-dark mb-2">Portfolio Analytics</h1>
                <p class="text-muted">Comprehensive insights into your investment performance</p>
            </div>
            
            <div id="portfolio-stats"></div>
            
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-chart-bar me-2 text-primary"></i>Performance Analysis</h4>
                            <small class="text-muted">Gain/Loss visualization with zero-line reference</small>
                        </div>
                        <div id="performance-chart"></div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-pie-chart me-2 text-success"></i>Portfolio Distribution</h4>
                            <small class="text-muted">Asset allocation by value</small>
                        </div>
                        <div style="position: relative; height: 280px;">
                            <canvas id="pie-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Second Row: Distribution Charts -->
                <div class="col-lg-4">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-industry me-2 text-info"></i>Sector Allocation</h4>
                            <small class="text-muted">Investment distribution across sectors</small>
                        </div>
                        <div id="sector-chart"></div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-layer-group me-2 text-warning"></i>Asset Types</h4>
                            <small class="text-muted">Breakdown by asset class</small>
                        </div>
                        <div style="position: relative; height: 280px;">
                            <canvas id="asset-type-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-shield-alt me-2 text-danger"></i>Risk Analysis</h4>
                            <small class="text-muted">Portfolio risk distribution</small>
                        </div>
                        <div style="position: relative; height: 280px;">
                            <canvas id="risk-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Third Row: Metrics -->
                <div class="col-lg-6">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-chart-line me-2 text-primary"></i>Transaction Volume</h4>
                            <small class="text-muted">Buy vs Sell activity over time</small>
                        </div>
                        <div style="position: relative; height: 280px;">
                            <canvas id="transaction-volume-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="glass-card rounded-4 p-4 h-100">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-balance-scale me-2 text-success"></i>Diversification Score</h4>
                            <small class="text-muted">Concentration risk analysis</small>
                        </div>
                        <div id="diversification-score"></div>
                    </div>
                </div>
                
                <!-- Fourth Row: Performance Details -->
                <div class="col-lg-6">
                    <div class="glass-card rounded-4 p-4">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-heartbeat me-2 text-danger"></i>Portfolio Health</h4>
                            <small class="text-muted">Key performance indicators</small>
                        </div>
                        <div id="health-metrics"></div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="glass-card rounded-4 p-4">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-chart-bar me-2 text-info"></i>Price Comparison</h4>
                            <small class="text-muted">Purchase vs Current price</small>
                        </div>
                        <div style="position: relative; height: 280px;">
                            <canvas id="performance-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Row: Holdings Detail -->
                <div class="col-12">
                    <div class="glass-card rounded-4 p-4">
                        <div class="mb-3">
                            <h4 class="text-dark mb-1"><i class="fas fa-trophy me-2 text-warning"></i>Top Holdings Performance</h4>
                            <small class="text-muted">Individual stock performance breakdown</small>
                        </div>
                        <div id="holdings-performance"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chatbot -->
    <div id="chatbot" class="chatbot-container">
        <div id="chatbot-header" class="chatbot-header" onclick="toggleChatbot()">
            <i class="fas fa-comments"></i>
            <span>Help</span>
        </div>
        <div id="chatbot-body" class="chatbot-body" style="display: none;">
            <div id="chatbot-messages" class="chatbot-messages">
                <div class="bot-message">Hi! I'm here to help with your portfolio. Ask me anything!</div>
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbot-input" placeholder="Type your question..." onkeypress="handleChatInput(event)">
                <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <style>
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .dark-mode .chatbot-container {
            background: #2c3e50;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .chatbot-header {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chatbot-body {
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        .chatbot-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            max-height: 240px;
        }
        .bot-message, .user-message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        .bot-message {
            background: #f1f3f4;
            color: #333;
            align-self: flex-start;
        }
        .dark-mode .bot-message {
            background: #34495e;
            color: #ecf0f1;
        }
        .user-message {
            background: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .chatbot-input {
            display: flex;
            padding: 12px;
            border-top: 1px solid #eee;
        }
        .dark-mode .chatbot-input {
            border-top: 1px solid #34495e;
        }
        .chatbot-input input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 12px;
            outline: none;
            background: white;
            color: #333;
        }
        .dark-mode .chatbot-input input {
            background: #34495e;
            border: 1px solid #555;
            color: #ecf0f1;
        }
        .dark-mode .chatbot-input input::placeholder {
            color: #bdc3c7;
        }
        .chatbot-input button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            margin-left: 8px;
            cursor: pointer;
        }
    </style>

    <script>
        const API_URL = '/api/portfolio';
        const USD_TO_INR_RATE = 83.5; // Approximate exchange rate
        let isUSD = false;
        
        function formatCurrency(amount) {
            if (isUSD) {
                return '$' + (amount / USD_TO_INR_RATE).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }
            return 'â‚¹' + amount.toLocaleString();
        }
        
        function getCurrencySymbol() {
            return isUSD ? '$' : 'â‚¹';
        }

        async function loadPortfolio() {
            try {
                const response = await fetch(API_URL);
                const holdings = await response.json();
                
                if (holdings.length === 0) {
                    document.querySelector('.main-content').innerHTML = `
                        <div class="glass-card rounded-4 p-4 mb-4">
                            <h1 class="h2 text-dark mb-2">Portfolio Analytics</h1>
                            <p class="text-muted">No data available for analysis</p>
                        </div>
                        <div class="glass-card rounded-4 p-5 text-center">
                            <i class="fas fa-chart-line display-1 text-muted opacity-25 mb-3"></i>
                            <h3 class="text-muted">No Portfolio Data</h3>
                            <p class="text-muted">Add some holdings to see detailed analytics and insights.</p>
                            <a href="index.html" class="btn btn-gradient btn-lg text-white mt-3">
                                <i class="fas fa-plus me-2"></i> Add Your First Holding
                            </a>
                        </div>
                    `;
                    return;
                }
                
                displayStats(holdings);
                displayPerformanceChart(holdings);
                displayPieChart(holdings);
                displaySectorChart(holdings);
                displayAssetTypeChart(holdings);
                displayRiskChart(holdings);
                displayHoldingsPerformance(holdings);
                displayTransactionVolumeChart();
                displayDiversificationScore(holdings);
                displayPerformanceComparisonChart(holdings);
                displayHealthMetrics(holdings);
            } catch (error) {
                console.error('Error loading portfolio:', error);
                document.getElementById('portfolio-stats').innerHTML = '<div class="message error">Error loading portfolio data.</div>';
            }
        }

        function displayStats(holdings) {
            const totalValue = holdings.reduce((sum, holding) => sum + (holding.current_price * holding.volume), 0);
            const totalCost = holdings.reduce((sum, holding) => sum + (holding.purchase_price * holding.volume), 0);
            const totalGainLoss = totalValue - totalCost;
            const gainLossPercent = totalCost > 0 ? ((totalGainLoss / totalCost) * 100) : 0;
            const bestPerformer = holdings.reduce((best, holding) => {
                const currentGain = ((holding.current_price - holding.purchase_price) / holding.purchase_price) * 100;
                const bestGain = ((best.current_price - best.purchase_price) / best.purchase_price) * 100;
                return currentGain > bestGain ? holding : best;
            }, holdings[0]);

            document.getElementById('portfolio-stats').innerHTML = `
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="glass-card rounded-3 p-3 text-center">
                            <div class="h3 text-primary mb-1" data-currency="${totalValue}">${formatCurrency(totalValue)}</div>
                            <small class="text-muted">Portfolio Value</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card rounded-3 p-3 text-center">
                            <div class="h3 ${totalGainLoss >= 0 ? 'text-success' : 'text-danger'} mb-1" data-currency="${totalGainLoss}">${formatCurrency(totalGainLoss)}</div>
                            <small class="text-muted">Total P&L (${gainLossPercent.toFixed(1)}%)</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card rounded-3 p-3 text-center">
                            <div class="h3 text-warning mb-1">${holdings.length}</div>
                            <small class="text-muted">Total Holdings</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card rounded-3 p-3 text-center">
                            <div class="h3 text-success mb-1">${bestPerformer.stock_ticker}</div>
                            <small class="text-muted">Best Performer</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayPerformanceChart(holdings) {
            const chartDiv = document.getElementById('performance-chart');
            const maxAbsValue = Math.max(...holdings.map(h => Math.abs((h.current_price - h.purchase_price) * h.volume)));
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#ffffff' : '#2c3e50';
            const lineColor = isDarkMode ? '#666666' : '#2c3e50';
            
            let html = '<div style="position: relative; padding: 20px 0;">';
            
            // Add zero line
            html += `<div style="position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: ${lineColor}; z-index: 1;"></div>`;
            html += `<div style="position: absolute; left: 50%; top: 10px; transform: translateX(-50%); background: ${lineColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 2;">${getCurrencySymbol()}0</div>`;
            
            holdings.forEach(holding => {
                const gainLoss = (holding.current_price - holding.purchase_price) * holding.volume;
                const percentage = ((holding.current_price - holding.purchase_price) / holding.purchase_price * 100).toFixed(1);
                const width = Math.min((Math.abs(gainLoss) / maxAbsValue) * 45, 45); // 45% max width, ensure it doesn't exceed
                
                if (gainLoss >= 0) {
                    // Positive performance - right side
                    html += `
                        <div style="display: flex; align-items: center; margin: 8px 0; height: 40px; position: relative;">
                            <div style="width: 50%; text-align: right; padding-right: 15px; font-weight: 600; color: ${textColor};">
                                ${holding.stock_ticker}
                            </div>
                            <div style="width: ${width}%; background: linear-gradient(90deg, #27ae60, #2ecc71); height: 100%; border-radius: 0 20px 20px 0; display: flex; align-items: center; padding-left: 15px; color: white; font-weight: 600; min-width: 100px; max-width: 45%;">
                                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" data-currency="${gainLoss}">+${formatCurrency(gainLoss)} (${percentage}%)</span>
                            </div>
                        </div>
                    `;
                } else {
                    // Negative performance - left side
                    html += `
                        <div style="display: flex; align-items: center; margin: 8px 0; height: 40px; position: relative;">
                            <div style="width: 50%; display: flex; justify-content: flex-end; position: relative;">
                                <div style="width: ${width}%; background: linear-gradient(270deg, #e74c3c, #c0392b); height: 40px; border-radius: 20px 0 0 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; color: white; font-weight: 600; min-width: 100px; max-width: 100%;">
                                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" data-currency="${Math.abs(gainLoss)}">-${formatCurrency(Math.abs(gainLoss))} (${Math.abs(parseFloat(percentage))}%)</span>
                                </div>
                            </div>
                            <div style="width: 50%; text-align: left; padding-left: 15px; font-weight: 600; color: ${textColor};">
                                ${holding.stock_ticker}
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        function displayPieChart(holdings) {
            const canvas = document.getElementById('pie-chart');
            const ctx = canvas.getContext('2d');
            
            const colors = ['#667eea', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#ff6b6b', '#4ecdc4'];
            const data = holdings.map((holding, index) => ({
                label: holding.stock_ticker,
                value: holding.current_price * holding.volume,
                color: colors[index % colors.length]
            }));
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.label),
                    datasets: [{
                        data: data.map(d => d.value),
                        backgroundColor: data.map(d => d.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        function displaySectorChart(holdings) {
            const sectorData = {};
            holdings.forEach(holding => {
                const sector = holding.sector || 'Others';
                const value = holding.current_price * holding.volume;
                sectorData[sector] = (sectorData[sector] || 0) + value;
            });

            const chartDiv = document.getElementById('sector-chart');
            const maxValue = Math.max(...Object.values(sectorData));
            const colors = ['#667eea', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#ffffff' : '#2c3e50';
            const mutedColor = isDarkMode ? '#b0b0b0' : '#7f8c8d';
            let html = '';
            let colorIndex = 0;

            Object.entries(sectorData).forEach(([sector, value]) => {
                const width = (value / maxValue) * 100;
                const percentage = ((value / Object.values(sectorData).reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                html += `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: ${textColor};">${sector}</span>
                            <span style="color: ${mutedColor};">${percentage}% (<span data-currency="${value}">${formatCurrency(value)}</span>)</span>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; height: 12px; overflow: hidden;">
                            <div style="width: ${width}%; height: 100%; background: ${colors[colorIndex % colors.length]}; border-radius: 10px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
                colorIndex++;
            });

            chartDiv.innerHTML = html;
        }

        function displayAssetTypeChart(holdings) {
            const assetTypeData = {};
            holdings.forEach(holding => {
                const assetType = (holding.asset_type || 'stock').toLowerCase();
                const value = holding.current_price * holding.volume;
                assetTypeData[assetType] = (assetTypeData[assetType] || 0) + value;
            });

            const canvas = document.getElementById('asset-type-chart');
            const ctx = canvas.getContext('2d');
            
            const assetTypeColors = {
                'stock': '#667eea',
                'etf': '#27ae60', 
                'crypto': '#f39c12',
                'bond': '#9b59b6',
                'cash': '#95a5a6'
            };
            
            const labels = Object.keys(assetTypeData).map(type => {
                switch(type) {
                    case 'stock': return 'Stocks';
                    case 'etf': return 'ETFs';
                    case 'crypto': return 'Cryptocurrency';
                    case 'bond': return 'Bonds';
                    case 'cash': return 'Cash';
                    default: return type.toUpperCase();
                }
            });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(assetTypeData),
                        backgroundColor: Object.keys(assetTypeData).map(type => assetTypeColors[type] || '#34495e'),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label}: ${percentage}% (${formatCurrency(value)})`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        function displayRiskChart(holdings) {
            const riskData = { low: 0, medium: 0, high: 0 };
            holdings.forEach(holding => {
                const value = holding.current_price * holding.volume;
                riskData[holding.risk_level] += value;
            });

            const canvas = document.getElementById('risk-chart');
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: [riskData.low, riskData.medium, riskData.high],
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        function displayHoldingsPerformance(holdings) {
            const chartDiv = document.getElementById('holdings-performance');
            let html = '<div class="row g-3">';
            
            // Sort holdings by percentage gain/loss (highest to lowest)
            const sortedHoldings = holdings.sort((a, b) => {
                const aPercentage = ((a.current_price - a.purchase_price) / a.purchase_price) * 100;
                const bPercentage = ((b.current_price - b.purchase_price) / b.purchase_price) * 100;
                return bPercentage - aPercentage;
            });
            
            sortedHoldings.forEach(holding => {
                const gainLoss = (holding.current_price - holding.purchase_price) * holding.volume;
                const percentage = ((holding.current_price - holding.purchase_price) / holding.purchase_price * 100).toFixed(2);
                const color = gainLoss >= 0 ? '#27ae60' : '#e74c3c';
                const icon = gainLoss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-start border-4" style="border-start-color: ${color} !important;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="card-title mb-1">${holding.stock_ticker}</h6>
                                        <small class="text-muted">${holding.company_name}</small>
                                    </div>
                                    <i class="fas ${icon} fa-lg" style="color: ${color};"></i>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Purchase:</span>
                                    <span class="fw-semibold" data-currency="${holding.purchase_price}">${formatCurrency(holding.purchase_price)}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Current:</span>
                                    <span class="fw-semibold" data-currency="${holding.current_price}">${formatCurrency(holding.current_price)}</span>
                                </div>
                                <div class="text-center p-3 rounded" style="background: rgba(${gainLoss >= 0 ? '40, 167, 69' : '220, 53, 69'}, 0.1);">
                                    <div class="h5 mb-1" style="color: ${color};">
                                        <span data-currency="${gainLoss}">${gainLoss >= 0 ? '+' : ''}${formatCurrency(gainLoss)}</span>
                                    </div>
                                    <small style="color: ${color}; font-weight: 600;">
                                        ${gainLoss >= 0 ? '+' : ''}${percentage}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        async function displayTransactionVolumeChart() {
            try {
                const response = await fetch(`${API_URL}/transactions`);
                const transactions = await response.json();
                
                const monthlyData = {};
                transactions.forEach(transaction => {
                    const month = new Date(transaction.transaction_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    if (!monthlyData[month]) {
                        monthlyData[month] = { buy: 0, sell: 0 };
                    }
                    monthlyData[month][transaction.transaction_type] += transaction.total_amount;
                });
                
                const canvas = document.getElementById('transaction-volume-chart');
                const ctx = canvas.getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(monthlyData),
                        datasets: [{
                            label: 'Buy Volume',
                            data: Object.values(monthlyData).map(d => d.buy),
                            backgroundColor: '#27ae60',
                            borderRadius: 8
                        }, {
                            label: 'Sell Volume',
                            data: Object.values(monthlyData).map(d => d.sell),
                            backgroundColor: '#e74c3c',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading transaction data:', error);
            }
        }
        
        function displayDiversificationScore(holdings) {
            const totalValue = holdings.reduce((sum, holding) => sum + (holding.current_price * holding.volume), 0);
            const weights = holdings.map(holding => (holding.current_price * holding.volume) / totalValue);
            
            // Calculate Herfindahl-Hirschman Index (HHI) for concentration
            const hhi = weights.reduce((sum, weight) => sum + (weight * weight), 0);
            const diversificationScore = Math.min(100, Math.max(0, (1 - hhi) * 100));
            
            // Sector diversification
            const sectors = {};
            holdings.forEach(holding => {
                const sector = holding.sector || 'Others';
                const value = holding.current_price * holding.volume;
                sectors[sector] = (sectors[sector] || 0) + value;
            });
            const sectorCount = Object.keys(sectors).length;
            
            const chartDiv = document.getElementById('diversification-score');
            chartDiv.innerHTML = `
                <div class="text-center mb-4">
                    <div class="position-relative d-inline-block">
                        <svg width="120" height="120" class="position-relative">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#e9ecef" stroke-width="8"></circle>
                            <circle cx="60" cy="60" r="50" fill="none" stroke="#667eea" stroke-width="8" 
                                stroke-dasharray="${(diversificationScore / 100) * 314} 314" 
                                stroke-dashoffset="0" transform="rotate(-90 60 60)" 
                                style="transition: stroke-dasharray 0.5s ease;"></circle>
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                            <div class="h3 text-primary mb-0">${diversificationScore.toFixed(0)}%</div>
                            <small class="text-muted">Score</small>
                        </div>
                    </div>
                </div>
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 text-primary mb-1">${holdings.length}</div>
                            <small class="text-muted">Assets</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-light rounded">
                            <div class="h5 text-success mb-1">${sectorCount}</div>
                            <small class="text-muted">Sectors</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        ${diversificationScore > 80 ? 'ðŸŸ¢ Well diversified portfolio' : 
                          diversificationScore > 60 ? 'ðŸŸ¡ Moderately diversified' : 
                          'ðŸ”´ Consider diversifying more'}
                    </small>
                </div>
            `;
        }
        
        function displayPerformanceComparisonChart(holdings) {
            const canvas = document.getElementById('performance-comparison-chart');
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: holdings.map(h => h.stock_ticker),
                    datasets: [{
                        label: 'Purchase Price',
                        data: holdings.map(h => h.purchase_price),
                        backgroundColor: '#95a5a6',
                        borderRadius: 6
                    }, {
                        label: 'Current Price',
                        data: holdings.map(h => h.current_price),
                        backgroundColor: holdings.map(h => h.current_price >= h.purchase_price ? '#27ae60' : '#e74c3c'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayHealthMetrics(holdings) {
            const totalValue = holdings.reduce((sum, holding) => sum + (holding.current_price * holding.volume), 0);
            const totalCost = holdings.reduce((sum, holding) => sum + (holding.purchase_price * holding.volume), 0);
            const totalGainLoss = totalValue - totalCost;
            
            const winners = holdings.filter(h => h.current_price > h.purchase_price).length;
            const losers = holdings.filter(h => h.current_price < h.purchase_price).length;
            const winRate = holdings.length > 0 ? (winners / holdings.length * 100) : 0;
            
            const avgGainLoss = holdings.length > 0 ? (totalGainLoss / holdings.length) : 0;
            const largestPosition = Math.max(...holdings.map(h => (h.current_price * h.volume) / totalValue * 100));
            
            const chartDiv = document.getElementById('health-metrics');
            chartDiv.innerHTML = `
                <div class="d-flex flex-column gap-3">
                    <div class="p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Win Rate</span>
                            <span class="fw-bold ${winRate >= 60 ? 'text-success' : winRate >= 40 ? 'text-warning' : 'text-danger'}">
                                ${winRate.toFixed(1)}%
                            </span>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar ${winRate >= 60 ? 'bg-success' : winRate >= 40 ? 'bg-warning' : 'bg-danger'}" 
                                 style="width: ${winRate}%"></div>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Avg P&L per Asset</span>
                            <span class="fw-bold ${avgGainLoss >= 0 ? 'text-success' : 'text-danger'}" data-currency="${avgGainLoss}">
                                ${formatCurrency(avgGainLoss)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted">Largest Position</span>
                            <span class="fw-bold ${largestPosition > 30 ? 'text-danger' : largestPosition > 20 ? 'text-warning' : 'text-success'}">
                                ${largestPosition.toFixed(1)}%
                            </span>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar ${largestPosition > 30 ? 'bg-danger' : largestPosition > 20 ? 'bg-warning' : 'bg-success'}" 
                                 style="width: ${Math.min(largestPosition, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-success bg-opacity-10 rounded text-center">
                                <div class="h6 text-success mb-0">${winners}</div>
                                <small class="text-muted">Winners</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-danger bg-opacity-10 rounded text-center">
                                <div class="h6 text-danger mb-0">${losers}</div>
                                <small class="text-muted">Losers</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }




        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const toggle = document.getElementById('theme-toggle');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'true');
            } else {
                localStorage.setItem('darkMode', 'false');
            }
            // Refresh charts with new theme colors
            loadPortfolio();
        }

        function toggleCurrency() {
            isUSD = !isUSD;
            localStorage.setItem('currency', isUSD ? 'USD' : 'INR');
            updateCurrencyDisplay();
        }
        
        function updateCurrencyDisplay() {
            // Update all currency displays without reloading data
            document.querySelectorAll('[data-currency]').forEach(element => {
                const amount = parseFloat(element.dataset.currency);
                const currentText = element.textContent;
                
                // Handle positive/negative signs and percentages
                if (currentText.includes('(') && currentText.includes('%)')) {
                    // Performance chart format: +$123 (5.2%)
                    const percentage = currentText.match(/\(([^)]+)%\)/)[1];
                    const sign = amount >= 0 ? '+' : '-';
                    element.textContent = `${sign}${formatCurrency(Math.abs(amount))} (${Math.abs(percentage)}%)`;
                } else if (currentText.includes('(') && currentText.includes(')')) {
                    // Sector chart format: 25% ($1,234)
                    const beforeParen = currentText.split('(')[0];
                    element.innerHTML = `${beforeParen}(<span data-currency="${amount}">${formatCurrency(amount)}</span>)`;
                } else if (currentText.startsWith('+') || currentText.startsWith('-')) {
                    // Holdings performance format: +$123
                    const sign = amount >= 0 ? '+' : '';
                    element.textContent = `${sign}${formatCurrency(amount)}`;
                } else {
                    // Simple currency format
                    element.textContent = formatCurrency(amount);
                }
            });
        }
        
        // Load saved theme and currency
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').checked = true;
        }
        
        if (localStorage.getItem('currency') === 'USD') {
            isUSD = true;
            document.getElementById('currency-toggle').checked = true;
        }

        function toggleChatbot() {
            const body = document.getElementById('chatbot-body');
            body.style.display = body.style.display === 'none' ? 'block' : 'none';
        }
        
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            setTimeout(async () => {
                const response = await getBotResponse(message);
                addMessage(response, 'bot');
            }, 500);
        }
        
        function addMessage(text, type) {
            const messages = document.getElementById('chatbot-messages');
            const div = document.createElement('div');
            div.className = type === 'user' ? 'user-message' : 'bot-message';
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        async function getBotResponse(message) {
            const msg = message.toLowerCase();
            
            let holdings = [];
            try {
                const response = await fetch(API_URL);
                holdings = await response.json();
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
            }
            
            if (msg.includes('suggest') || msg.includes('recommend') || msg.includes('advice')) {
                return getPortfolioSuggestions(holdings);
            }
            if (msg.includes('diversif') || msg.includes('sector')) {
                return getDiversificationAdvice(holdings);
            }
            if (msg.includes('risk')) {
                return getRiskAnalysis(holdings);
            }
            if (msg.includes('performance') || msg.includes('profit') || msg.includes('loss')) {
                return getPerformanceInsights(holdings);
            }
            if (msg.includes('portfolio') || msg.includes('holdings')) {
                return 'You can view your portfolio on the "View Portfolio" page or see analytics here!';
            }
            if (msg.includes('add') || msg.includes('buy')) {
                return 'To add new holdings, go to the "Add Holdings" page and fill in the stock details.';
            }
            if (msg.includes('sell')) {
                return 'You can sell your holdings from the "Sell Holdings" page. Select the stock and quantity to sell.';
            }
            if (msg.includes('analytics') || msg.includes('charts')) {
                return 'This analytics page shows your portfolio performance, sector allocation, and risk analysis!';
            }
            if (msg.includes('currency') || msg.includes('usd') || msg.includes('inr')) {
                return 'Use the currency toggle in the sidebar to switch between INR and USD display.';
            }
            if (msg.includes('dark mode') || msg.includes('theme')) {
                return 'Toggle dark mode using the switch in the sidebar for a better viewing experience.';
            }
            if (msg.includes('help') || msg.includes('how')) {
                return 'I can help you navigate the portfolio app. Try asking about suggestions, diversification, risk analysis, or any other features!';
            }
            
            return 'I\'m here to help with your portfolio management. Ask me about suggestions, diversification, risk analysis, or any other features!';
        }
        
        function getPortfolioSuggestions(holdings) {
            if (holdings.length === 0) return 'Start by adding some holdings to get personalized suggestions!';
            
            const suggestions = [];
            const sectors = {};
            const riskLevels = { low: 0, medium: 0, high: 0 };
            let totalValue = 0;
            
            holdings.forEach(holding => {
                const value = holding.current_price * holding.volume;
                totalValue += value;
                sectors[holding.sector || 'Others'] = (sectors[holding.sector || 'Others'] || 0) + value;
                riskLevels[holding.risk_level] += value;
            });
            
            const maxSectorValue = Math.max(...Object.values(sectors));
            if (maxSectorValue / totalValue > 0.4) {
                suggestions.push('Consider diversifying - one sector represents >40% of your portfolio.');
            }
            
            const highRiskPercent = (riskLevels.high / totalValue) * 100;
            if (highRiskPercent > 30) {
                suggestions.push('High-risk holdings exceed 30%. Consider rebalancing for stability.');
            }
            
            const losers = holdings.filter(h => h.current_price < h.purchase_price);
            if (losers.length > holdings.length * 0.6) {
                suggestions.push('60%+ holdings are in loss. Review and consider stop-loss strategies.');
            }
            
            return suggestions.length > 0 ? suggestions.join(' ') : 'Your portfolio looks well-balanced! Keep monitoring performance.';
        }
        
        function getDiversificationAdvice(holdings) {
            if (holdings.length === 0) return 'Add holdings first to get diversification advice!';
            
            const sectors = {};
            holdings.forEach(holding => {
                sectors[holding.sector || 'Others'] = (sectors[holding.sector || 'Others'] || 0) + 1;
            });
            
            const sectorCount = Object.keys(sectors).length;
            const dominantSector = Object.entries(sectors).reduce((a, b) => a[1] > b[1] ? a : b);
            
            if (sectorCount < 3) {
                return `You're only in ${sectorCount} sector(s). Consider adding Healthcare, Consumer Goods, or Manufacturing stocks for better diversification.`;
            }
            
            if (dominantSector[1] > holdings.length * 0.5) {
                return `${dominantSector[0]} dominates your portfolio. Consider reducing exposure and adding other sectors like Pharma, FMCG, or Auto.`;
            }
            
            return 'Good sector diversification! You\'re spread across multiple sectors which reduces risk.';
        }
        
        function getRiskAnalysis(holdings) {
            if (holdings.length === 0) return 'Add holdings to get risk analysis!';
            
            const riskCounts = { low: 0, medium: 0, high: 0 };
            holdings.forEach(holding => riskCounts[holding.risk_level]++);
            
            const highRiskPercent = (riskCounts.high / holdings.length) * 100;
            const lowRiskPercent = (riskCounts.low / holdings.length) * 100;
            
            if (highRiskPercent > 50) {
                return 'High risk alert! 50%+ holdings are high-risk. Consider adding stable blue-chip stocks like HDFC Bank or TCS for balance.';
            }
            
            if (lowRiskPercent > 70) {
                return 'Very conservative portfolio. Consider adding some growth stocks for better returns, but maintain your risk tolerance.';
            }
            
            return `Balanced risk profile: ${lowRiskPercent.toFixed(0)}% low-risk, ${((riskCounts.medium/holdings.length)*100).toFixed(0)}% medium-risk, ${highRiskPercent.toFixed(0)}% high-risk.`;
        }
        
        function getPerformanceInsights(holdings) {
            if (holdings.length === 0) return 'Add holdings to get performance insights!';
            
            const winners = holdings.filter(h => h.current_price > h.purchase_price);
            const losers = holdings.filter(h => h.current_price < h.purchase_price);
            
            const totalGainLoss = holdings.reduce((sum, h) => sum + ((h.current_price - h.purchase_price) * h.volume), 0);
            const winRate = (winners.length / holdings.length) * 100;
            
            if (winRate > 70) {
                return `Excellent! ${winRate.toFixed(0)}% of your holdings are profitable. Consider booking some profits and diversifying further.`;
            }
            
            if (winRate < 40) {
                return `${winRate.toFixed(0)}% win rate is concerning. Review underperforming stocks and consider stop-loss or averaging down strategies.`;
            }
            
            const bestPerformer = holdings.reduce((best, h) => {
                const bestGain = ((best.current_price - best.purchase_price) / best.purchase_price) * 100;
                const currentGain = ((h.current_price - h.purchase_price) / h.purchase_price) * 100;
                return currentGain > bestGain ? h : best;
            });
            
            return `${winRate.toFixed(0)}% win rate. Best performer: ${bestPerformer.stock_ticker}. ${totalGainLoss >= 0 ? 'Overall profitable!' : 'Overall in loss - review strategy.'}`;
        }

        loadPortfolio();
    </script>
</body>
</html>